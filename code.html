<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="code.pageTitle">MediLingua Quiz</title>
    <link rel="stylesheet" href="styles.css">
    <script src="languageSwitcher.js" defer></script>
</head>
<body>
    <div class="navbar">
        <a href="index.html" data-i18n="navbar.home">Home</a>
        <a href="about.html" data-i18n="navbar.about">About Us</a>
        <a href="quiz.html" data-i18n="navbar.quiz">Quiz</a>
        <a href="lexicon.html" data-i18n="navbar.lexicon">Lexicon</a>
        <a href="symptomata.html" data-i18n="navbar.symptomata">Symptomata</a>
        <select id="languageSwitcher">
            <option value="en">English</option>
            <option value="cz" selected>Čeština</option>
        </select>
    </div>

    <header>
        <h1 data-i18n="code.headerTitle">MediLingua Quiz</h1>
    </header>

    <div class="content">
        <h2 data-i18n="code.contentTitle">Select Practice Areas</h2>
        <p data-i18n="code.contentIntro">Choose the declensions, cases, and topics you want to practice.</p>

        <!-- Labels and inputs -->
        <label data-i18n="code.labelDeclensions">Declensions:</label>
        <select id="declensions"></select>

        <label data-i18n="code.labelCases">Cases:</label>
        <select id="cases"></select>

        <label data-i18n="code.labelTopics">Topics:</label>
        <select id="topics"></select>

        <button onclick="startQuiz()" data-i18n="code.quizButton">Start Quiz!</button>
    </div>

    <footer>
        <p data-i18n="footer">© Lukáš Marônek 2024. All rights reserved.</p>
    </footer>

    <!-- JavaScript to handle translations and data loading -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const languageSwitcher = document.getElementById('languageSwitcher');

            function loadLanguage(lang) {
                fetch(`lang-${lang}.json`)
                    .then(response => response.json())
                    .then(data => {
                        // Update all elements with the 'data-i18n' attribute
                        document.querySelectorAll('[data-i18n]').forEach(element => {
                            const keys = element.getAttribute('data-i18n').split('.');
                            let translation = data;
                            keys.forEach(key => {
                                translation = translation[key];
                            });
                            element.textContent = translation;
                        });
                    })
                    .catch(error => console.error('Error loading language:', error));
            }
            // Load initial language from localStorage or default to 'cz'
            const savedLang = localStorage.getItem('selectedLanguage') || 'cz';
            languageSwitcher.value = savedLang;
            loadLanguage(savedLang);

            languageSwitcher.addEventListener('change', () => {
                const selectedLang = languageSwitcher.value;
                localStorage.setItem('selectedLanguage', selectedLang);
                loadLanguage(selectedLang);
            });
        });
        fetch('navbar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('navbar-placeholder').innerHTML = data;
        })
        .catch(error => console.error('Error loading navbar:', error));
        
        function endsWithTwoConsonants(word) {
            // Define a regular expression to match two consonants at the end of the word
            var regex = /[bcdfghjklmnpqrstvwxyz]{2}$/i;

            // Test the word against the regular expression
            return regex.test(word);
        }

        function isIStem(word) {
            // Define a regular expression to match the specified endings
            var regex = /(al|ar|e)$/i;

            // Test the word against the regular expression
            return regex.test(word);
        }
        
        function handleKeyDown(event) {
                // Check if the pressed key is Enter (key code 13)
                if (event.keyCode === 13) {
                    // Call the function to submit the guess
                    submitGuess();
                }
            }
        
        let wordsData = []; // To store words loaded from weeks
        let selectedCases = [];
        const numbers = ['Singular', 'Plural'];
        let selectedDeclensions = [];
        let currentWord, currentCase, currentNumber;

        function startQuiz() {
            selectedDeclensions = getSelectedDeclensions();
            selectedWeeks = getSelectedWeeks();
            selectedCases = getSelectedCases();
            console.log("Selected cases:", selectedCases);

            if (selectedDeclensions.length === 0 || selectedWeeks.length === 0 | selectedCases.length === 0) {
                alert("Prosím, vyberte alespoň jednu deklinaci, jeden pád a jedno téma.");
                return;
            }

            // Load words from selected week files
            loadWeekData(selectedWeeks, () => {
                getRandomWordAndCase();
                document.getElementById('quizContainer').style.display = 'block';
            });
        }

        function getSelectedDeclensions() {
            return [...document.getElementsByClassName('declensionCheckbox')]
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        function getSelectedWeeks() {
            return [...document.getElementsByClassName('weekCheckbox')]
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        function getSelectedCases() {
            return [...document.getElementsByClassName('caseCheckbox')]
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        function loadWeekData(weeks, callback) {
            wordsData = [];
            let loadedFiles = 0;

            weeks.forEach(week => {
                const weekFile = week.toLowerCase() + '.txt';
                console.log("Fetching file:", weekFile); // Log the file being fetched
                fetch(weekFile)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.text();
                    })
                    .then(data => {
                        data.split('\n').forEach((line, index) => {
                            line = line.trim(); // Trim whitespace
                            if (line === '') return; // Skip empty lines

                            const parts = line.split(',');
                            // Log the line to see what we are getting
                            console.log(`Line ${index + 1}: ${line}`); // Log the raw line

                            // Check if the parts array has exactly 3 elements
                            if (parts.length === 3) {
                                const [word, genitive, gender] = parts.map(part => part.trim());
                                wordsData.push({ word, genitive, gender });
                            } else {
                                console.warn(`Invalid line format at line ${index + 1} in ${weekFile}:`, parts); // Log invalid lines with their parts
                            }
                        });
                        if (++loadedFiles === weeks.length) callback();
                    })
                    .catch(error => {
                        console.error('Error fetching week data:', error);  // Log errors in fetching
                    });
            });
        }

        function getRandomWordAndCase() {
            clearInputField();
        
            const filteredWords = wordsData.filter(word => selectedDeclensions.includes(determineDeclension(word)));
            if (filteredWords.length === 0) {
                alert("Pro vybranou deklinaci nejsou v slovní zásobě žádná slova.");
                return;
            }
        
            const randomWord = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            // Check if selectedCases is not empty before choosing a case
            if (selectedCases.length > 0) {
                const randomCase = selectedCases[Math.floor(Math.random() * selectedCases.length)];
                console.log("Chosen case:", randomCase); // Log the chosen case
                const randomNumber = getRandomElement(numbers);
    
                currentWord = randomWord;
                currentCase = randomCase;
                currentNumber = randomNumber;
                if (currentCase === "Nominative"){
                    currentNumber = "Plural";
                    console.log("Current case is", currentCase, "current number should be now plural and is:", currentNumber); // Log the chosen case
                }

                document.getElementById('randomWord').innerText = 'Slovo: ' + currentWord.word;
                document.getElementById('randomCaseNumber').innerText = 'Pád a číslo: ' + currentCase + ' ' + currentNumber;
                
            } else {
                console.error("No cases selected.");
                alert("Vyberte alespoň jeden pád.");
            }
        }

        function submitGuess() {
            const userGuess = document.getElementById('userGuess').value.toLowerCase();
            const correctAnswer = checkGuess();
            if (userGuess === correctAnswer) {
                alert("Správně!");
            } else {
                alert("Nesprávně. Správná odpověď je: " + correctAnswer);
            }
            getRandomWordAndCase();
        }

        function determineDeclension(word) {
            if (word.genitive.endsWith("ei") && (word.word.endsWith("es"))) return "V";
            if (word.genitive.endsWith("ae")) return "I";
            if (word.genitive.endsWith("i")) return "II";
            if (word.genitive.endsWith("is")) return "III";
            if (word.genitive.endsWith("us")) return "IV";
            return ''; // Return an empty string if no declension is found
        }

        function checkGuess() {
            let trunk = currentWord.genitive.slice(0, -2);
            if (determineDeclension(currentWord) === "II") {
                trunk = currentWord.genitive.slice(0, -1);
            }
            let correctForm = '';
            // (currentWord.gender === 'n' ? 'a' : 'i')
            // Add logic for Nominative and Genitive
            if (currentCase === 'Nominative') {
                if (determineDeclension(currentWord) === "I"){
                correctForm = currentNumber === 'Singular' ? currentWord.word : trunk + "ae";
                } else if (determineDeclension(currentWord) === "II"){
                correctForm = currentNumber === 'Singular' ? currentWord.word : trunk + (currentWord.gender === 'n' ? 'a' : 'i');
                } else if (determineDeclension(currentWord) === "III"){
                    if (currentNumber === 'Singular'){
                        correctForm = currentWord.word
                    } else if (isIStem(currentWord.word)){
                            correctForm = trunk + "ia";
                        } else if (currentWord.gender === "n") {correctForm = trunk + "a"
                        } else {correctForm = trunk + "es"}
                } else if (determineDeclension(currentWord) === "IV"){
                correctForm = currentNumber === 'Singular' ? currentWord.word : trunk + (currentWord.gender === 'n' ? 'ua' : 'us');
                } else {correctForm = currentNumber === 'Singular' ? currentWord.word : trunk + "es";
                       }
            } else if (currentCase === 'Genitive') {
                if (determineDeclension(currentWord) === "I"){
                correctForm = currentNumber === 'Singular' ? currentWord.genitive : trunk + "arum";
                } else if (determineDeclension(currentWord) === "II"){
                correctForm = currentNumber === 'Singular' ? currentWord.genitive : trunk + "orum";
                } else if (determineDeclension(currentWord) === "III"){
                    if (currentNumber === 'Singular'){
                        correctForm = currentWord.genitive
                    } else if (currentWord.word === "vas"){
                        correctForm = "vasorum";
                    } else if (isIStem(currentWord.word) || currentWord.word.endsWith("sis") || currentWord.word.endsWith("xis")){
                            correctForm = trunk + 'ium';
                        } else if (endsWithTwoConsonants(trunk) || currentWord.word === trunk + "is"){
                            correctForm = trunk + 'ium';
                        } else {correctForm = trunk + 'um'}
                } else if (determineDeclension(currentWord) === "IV"){
                correctForm = currentNumber === 'Singular' ? currentWord.genitive : trunk + "uum";
                } else {correctForm = currentNumber === 'Singular' ? currentWord.genitive : trunk + "erum";
                       }
            } else if (currentCase === 'Accusative'){
                if (determineDeclension(currentWord) === "I"){
                correctForm = currentNumber === 'Singular' ? trunk + "am" : trunk + "as";
                } else if (determineDeclension(currentWord) === "II"){
                    if (currentWord.gender === "n"){
                        correctForm = currentNumber === 'Singular' ? currentWord.word : trunk + "a";
                    } else {
                correctForm = currentNumber === 'Singular' ? trunk + "um" : trunk + "os";
                    }
                } else if (determineDeclension(currentWord) === "III"){
                    if (currentNumber === 'Singular'){
                        if (currentWord.gender === "n"){
                            correctForm = currentWord.word
                        } else if (isIStem(currentWord.word) || currentWord.word.endsWith("sis") || currentWord.word.endsWith("xis")){
                            correctForm = trunk + 'im';
                        } else {
                            correctForm = trunk + 'em';
                        }
                    } else {
                        if (isIStem(currentWord.word)){
                            correctForm = trunk + "ia";
                        } else if (currentWord.gender === "n") {
                            correctForm = trunk + "a";
                        } else {
                            correctForm = trunk + "es";
                        }
                    }
                } else if (determineDeclension(currentWord) === "IV"){
                    if (currentWord.gender === "n") {
                        correctForm = currentNumber === 'Singular' ? currentWord.word : trunk + "ua";
                    } else {
                        correctForm = currentNumber === 'Singular' ? trunk + "um" : trunk + "us";
                    }
                } else {correctForm = currentNumber === 'Singular' ? trunk + "em" : trunk + "es";
                       }   
            } else if (currentCase === 'Ablative') {
                if (determineDeclension(currentWord) === "I") {
                    correctForm = currentNumber === 'Singular' ? trunk + "a" : trunk + "is";
                    console.log("Správny tvar pre abl", correctForm);
                } else if (determineDeclension(currentWord) === "II") {
                    correctForm = currentNumber === 'Singular' ? trunk + "o" : trunk + "is";
                } else if (determineDeclension(currentWord) === "III") {
                    if (currentNumber === 'Singular') {
                        correctForm = isIStem(currentWord.word) ? trunk + "i" : trunk + "e";
                    } else {
                        correctForm = currentWord.word === "vas" ? "vasis" : trunk + "ibus";
                    }
                } else if (determineDeclension(currentWord) === "IV") {
                    correctForm = currentNumber === 'Singular' ? trunk + "u" : trunk + "ibus";
                } else { // For declension V or default case
                    correctForm = currentNumber === 'Singular' ? trunk + "e" : trunk + "ebus";
                }
            }

            return correctForm.toLowerCase();
        }

        function clearInputField() {
            document.getElementById('userGuess').value = '';
        }

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
    </script>
</body>
</html>
